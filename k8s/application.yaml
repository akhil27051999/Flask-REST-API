# Namespace for application with Helm labels
apiVersion: v1
kind: Namespace
metadata:
  name: student-api
  labels:
    app.kubernetes.io/name: student-api
    app.kubernetes.io/instance: student-api
    app.kubernetes.io/managed-by: Helm
  annotations:
    meta.helm.sh/release-name: student-api
    meta.helm.sh/release-namespace: student-api
---
# ConfigMap for Flask API with Helm labels
apiVersion: v1
kind: ConfigMap
metadata:
  name: flask-config
  namespace: student-api
  labels:
    app.kubernetes.io/name: student-api
    app.kubernetes.io/instance: student-api
    app.kubernetes.io/component: config
    app.kubernetes.io/managed-by: Helm
  annotations:
    meta.helm.sh/release-name: student-api
    meta.helm.sh/release-namespace: student-api
data:
  POSTGRES_HOST: "postgres"
  POSTGRES_PORT: "5432"
  POSTGRES_DB: "studentdb"
---
# Deployment for Flask REST API with Helm labels
apiVersion: apps/v1
kind: Deployment
metadata:
  name: flask-api
  namespace: student-api
  labels:
    app.kubernetes.io/name: student-api
    app.kubernetes.io/instance: student-api
    app.kubernetes.io/component: api
    app.kubernetes.io/managed-by: Helm
  annotations:
    meta.helm.sh/release-name: student-api
    meta.helm.sh/release-namespace: student-api
spec:
  replicas: 2
  selector:
    matchLabels:
      app: flask-api
  template:
    metadata:
      labels:
        app: flask-api
        app.kubernetes.io/name: student-api
        app.kubernetes.io/instance: student-api
    spec:
      nodeSelector:
        type: application
      initContainers:
        - name: db-migrations
          image: akhilthyadi/flask-app:7.0.0
          workingDir: /api/app
          env:
            - name: FLASK_APP
              value: "wsgi.py"
            - name: POSTGRES_USER
              valueFrom:
                secretKeyRef:
                  name: postgres-secret
                  key: POSTGRES_USER
            - name: POSTGRES_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: postgres-secret
                  key: POSTGRES_PASSWORD
            - name: POSTGRES_HOST
              valueFrom:
                configMapKeyRef:
                  name: flask-config
                  key: POSTGRES_HOST
            - name: POSTGRES_PORT
              valueFrom:
                configMapKeyRef:
                  name: flask-config
                  key: POSTGRES_PORT
            - name: POSTGRES_DB
              valueFrom:
                configMapKeyRef:
                  name: flask-config
                  key: POSTGRES_DB
          command:
            - sh
            - -c
            - |
              echo "Waiting for Postgres at $POSTGRES_HOST:$POSTGRES_PORT..."
              until pg_isready -h $POSTGRES_HOST -p $POSTGRES_PORT -U $POSTGRES_USER; do
                sleep 2
              done
              echo "Postgres is ready, running migrations..."
              flask db upgrade
      containers:
        - name: flask-api
          image: akhilthyadi/flask-app:7.0.0
          ports:
            - containerPort: 5000
          env:
            - name: POSTGRES_USER
              valueFrom:
                secretKeyRef:
                  name: postgres-secret
                  key: POSTGRES_USER
            - name: POSTGRES_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: postgres-secret
                  key: POSTGRES_PASSWORD
            - name: POSTGRES_HOST
              valueFrom:
                configMapKeyRef:
                  name: flask-config
                  key: POSTGRES_HOST
            - name: POSTGRES_PORT
              valueFrom:
                configMapKeyRef:
                  name: flask-config
                  key: POSTGRES_PORT
            - name: POSTGRES_DB
              valueFrom:
                configMapKeyRef:
                  name: flask-config
                  key: POSTGRES_DB
---
# Service to expose Flask API with Helm labels
apiVersion: v1
kind: Service
metadata:
  name: flask-api-service
  namespace: student-api
  labels:
    app.kubernetes.io/name: student-api
    app.kubernetes.io/instance: student-api
    app.kubernetes.io/component: service
    app.kubernetes.io/managed-by: Helm
  annotations:
    meta.helm.sh/release-name: student-api
    meta.helm.sh/release-namespace: student-api
spec:
  selector:
    app: flask-api
  ports:
    - protocol: TCP
      port: 80
      targetPort: 5000
  type: NodePort